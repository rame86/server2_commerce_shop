name: Shop Service CI/CD

on:
  push:
    branches: [ main ] # Shop은 main 브랜치 기준

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 1. Shop 서비스 빌드 (Gradle)
      - name: Build Shop Service
        run: |
          chmod +x gradlew
          ./gradlew build -x test

      # 2. DockerHub 로그인
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. 이미지 빌드 및 푸시
      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/msa-shop:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/msa-shop:latest

      # 4. GCP Server 2 배포
# ... (앞부분 생략: 빌드 및 도커 푸시 단계는 동일)

      - name: Deploy to GCP Server 2
        uses: appleboy/ssh-action@master
        with:
          host: 34.50.60.193
          username: oksm1003
          key: ${{ secrets.GCP_KEY }}
          script: |
            cd /home/oksm1003/shop 
            
            # 레포지토리 주소를 rame86 것으로 명확히 지정
            git remote set-url origin https://github.com/rame86/server2_commerce_shop.git
            git pull origin main
            
            # .env 설정 및 실행 (나머지 동일)
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" > .env
            echo "DB_USER=${{ secrets.POSTGRES_USER }}" >> .env
            echo "DB_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
            echo "RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}" >> .env
            echo "RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }}" >> .env
            echo "TZ=Asia/Seoul" >> .env
            
            docker compose pull
            docker compose up -d
            docker image prune -f